#!/usr/bin/env ruby

system("./cleanup")

$bits = 1024;
$enc = "-des3"

$pass = "file:inputs/passphrase.txt"
$subj = "/C=US/ST=California/L=LosAngeles/CN=lvh.me"
$out = "./output"

$client_ca_root_priv = "#{$out}/client_ca_root_priv.key"
$client_ca_root_publ = "#{$out}/client_ca_root_publ.crt"
$client_ca_root_priv_nopass = "#{$client_ca_root_priv}.nopass"

$server_priv = "#{$out}/server_priv.key"
$server_csr  = "#{$out}/server_csr"
$server_publ = "#{$out}/server_publ.crt"
$server_priv_nopass = "#{$server_priv}.nopass"

$client_priv = "#{$out}/client_priv.key"
$client_publ = "#{$out}/client_publ.crt"
$client_csr  = "#{$out}/client_csr"
$client_priv_nopass = "#{$client_priv}.nopass"
$client_combined_pem = "#{$out}/client_combined.pem"
$client_combined_pfx = "#{$out}/client_combined.pfx"

# Create the CA Key and Certificate for signing Client Certs
system("openssl genrsa #{$enc} -out #{$client_ca_root_priv} -passout #{$pass} #{$bits}")
system("openssl rsa -in #{$client_ca_root_priv} -out #{$client_ca_root_priv_nopass} -passin #{$pass}")
system("openssl req -new -x509 -days 365 -key #{$client_ca_root_priv} -passin #{$pass} -subj '#{$subj}' -out #{$client_ca_root_publ}")

# Create the Server Key, CSR, and Certificate
system("openssl genrsa #{$enc} -out #{$server_priv} -passout #{$pass} #{$bits}")
system("openssl req -new -key #{$server_priv} -passin #{$pass} -subj '#{$subj}' -out #{$server_csr}")
system("openssl rsa -in #{$server_priv} -out #{$server_priv_nopass} -passin #{$pass}")

# SELF-SIGN
system("openssl x509 -req -days 365 -in #{$server_csr} -signkey #{$server_priv_nopass} -out #{$server_publ}");

# Create the Client Key and CSR
system("openssl genrsa #{$enc} -out #{$client_priv} -passout #{$pass} #{$bits}")
system("openssl rsa -in #{$client_priv} -out #{$client_priv_nopass} -passin #{$pass}")
system("openssl req -new -key #{$client_priv_nopass} -subj #{$subj} -out #{$client_csr}")

# Sign the client certificate with our CA cert.
system("openssl x509 -req -days 365 -in #{$client_csr} -CA #{$client_ca_root_publ} -CAkey #{$client_ca_root_priv_nopass} -set_serial 01 -out #{$client_publ}")

system("cat #{$client_publ} #{$client_priv_nopass} > #{$client_combined_pem}")

system("openssl pkcs12 -export -out #{$client_combined_pfx} -inkey #{$client_priv_nopass} -in #{$client_publ} -certfile #{$client_ca_root_publ} -passout #{$pass}")

system("sudo systemctl restart nginx")

puts "************* Preparing to CURL"

sleep 1
puts `./curl_lvh_with_ca_crt`